<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
  {% set first_case_id = sessions[0].case_id if sessions else None %}
  {% set interactive_count = case_sessions | length %}
  {% set archived_count = sessions | length %}
  <header class="site-nav">
    <div class="site-nav__inner container">
      <a class="site-nav__brand" href="{{ url_for('index') }}">CaseSentinel</a>
      <nav class="site-nav__links" aria-label="Primary">
        <a class="site-nav__link{% if request.url.path == '/' %} is-active{% endif %}" href="{{ url_for('index') }}">Dashboard</a>
        <a class="site-nav__link{% if '/agents' in request.url.path %} is-active{% endif %}" href="{{ url_for('agents_view') }}">Agents</a>
        <a class="site-nav__link{% if request.url.path.startswith('/session') %} is-active{% endif %}{% if not first_case_id %} is-disabled{% endif %}" href="{{ url_for('session_view', case_id=first_case_id) if first_case_id else '#' }}" {% if not first_case_id %}aria-disabled="true"{% endif %}>Archive</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero hero--split hero--demo container">
      <div class="hero__primary">
        <p class="hero__eyebrow">Interactive orchestration</p>
        <h1>{{ title }}</h1>
        <p class="hero__subtitle">Launch a room in seconds, watch the multi-agent loop progress, and share the archive when the threshold is met.</p>
        <div class="hero__actions">
          <a class="btn" href="{{ url_for('agents_view') }}">Browse agents</a>
          {% if first_case_id %}
            <a class="btn-secondary" href="{{ url_for('session_view', case_id=first_case_id) }}">Latest archive</a>
          {% else %}
            <span class="btn-secondary is-disabled" aria-disabled="true">No archives yet</span>
          {% endif %}
        </div>
        <div class="hero__inline">
          <span class="pill pill--neutral">{{ interactive_count }} live rooms</span>
          <span class="pill pill--muted">{{ archived_count }} archived</span>
          <span class="pill pill--outline">Outputs live under <code>outputs/sessions</code></span>
        </div>
      </div>
      <div class="hero__aside hero__aside--stack">
        <article class="stat-card stat-card--contrast">
          <p class="stat-label">Quick demo tip</p>
          <p class="stat-value">Pick a preset</p>
          <p class="stat-detail">Then toggle ‚ÄúAuto-open workspace‚Äù to jump straight into the interactive room.</p>
        </article>
        <article class="stat-card">
          <p class="stat-label">Success threshold</p>
          <p class="stat-value">80%</p>
          <p class="stat-detail">Default stop condition (editable below)</p>
        </article>
      </div>
    </section>

    <section class="section-card container demo-rail" aria-labelledby="quickstart-heading">
      <header class="section-heading">
        <div>
          <h2 id="quickstart-heading">Pick a quick-start</h2>
          <p class="section-subtitle">Pre-fill the form for common demos. You can still tweak fields before launching.</p>
        </div>
        <label class="toggle">
          <input type="checkbox" id="auto-open-workspace" checked>
          <span>Auto-open workspace after launch</span>
        </label>
      </header>
      <div class="quickstart-grid">
        <button type="button" class="quick-card" data-quickstart="dataset">
          <div class="quick-card__head">
            <span class="quick-card__icon" aria-hidden="true">üìÇ</span>
            <span class="pill">Dataset</span>
          </div>
          <h3>Cleaned dataset</h3>
          <p>Load a record from <code>outputs/cleaned_cases.jsonl</code> and start iterating.</p>
        </button>
        <button type="button" class="quick-card" data-quickstart="raw">
          <div class="quick-card__head">
            <span class="quick-card__icon" aria-hidden="true">üìù</span>
            <span class="pill pill--muted">Raw</span>
          </div>
          <h3>Paste raw judgment</h3>
          <p>Drop original text; the cleaner will build a structured case before the agents run.</p>
        </button>
        <button type="button" class="quick-card" data-quickstart="live">
          <div class="quick-card__head">
            <span class="quick-card__icon" aria-hidden="true">‚ú®</span>
            <span class="pill pill--accent">Live</span>
          </div>
          <h3>Blank live case</h3>
          <p>Bootstrap an empty template with a title, summary, and optional charges to co-edit in the room.</p>
        </button>
      </div>
    </section>

    <section class="section-card container" aria-labelledby="launch-heading">
      <header class="section-heading">
        <div>
          <h2 id="launch-heading">Launch a collaborative session</h2>
          <p class="section-subtitle">Choose the source, adjust thresholds, and spin up the control room.</p>
        </div>
        <div class="section-actions">
          <span class="pill pill--outline">Step 1 ¬∑ Configure</span>
          <span class="pill pill--outline">Step 2 ¬∑ Launch</span>
          <span class="pill pill--outline">Step 3 ¬∑ Review</span>
        </div>
      </header>
      <form id="case-session-form" class="form-grid" autocomplete="off">
        <fieldset class="form-mode">
          <legend>Case source</legend>
          <label class="radio">
            <input type="radio" name="case_source" value="dataset" checked>
            <span>
              <strong>Cleaned dataset</strong>
              <small>Pull a record from cleaned json</small>
            </span>
          </label>
          <label class="radio">
            <input type="radio" name="case_source" value="raw">
            <span>
              <strong>Raw text</strong>
              <small>Paste an original document and auto-clean it</small>
            </span>
          </label>
          <label class="radio">
            <input type="radio" name="case_source" value="structured">
            <span>
              <strong>Structured JSON</strong>
              <small>Import a ready-to-use <code>CaseRecord</code> payload</small>
            </span>
          </label>
          <label class="radio">
            <input type="radio" name="case_source" value="live">
            <span>
              <strong>New live case</strong>
              <small>Start from an empty template and fill details later</small>
            </span>
          </label>
        </fieldset>

        <div class="source-group" data-source-section="dataset">
          <label>
            Cleaned dataset path
            <input type="text" name="cleaned_cases_path" value="outputs/cleaned_cases.jsonl" required>
          </label>
          <label>
            Case index
            <input type="number" name="case_index" value="0" min="0">
          </label>
        </div>

        <div class="source-group full-width" data-source-section="raw" hidden>
          <label>
            Raw judgment text
            <textarea name="raw_case_text" rows="6" placeholder="Paste the original judgment; the parser will extract a structured record."></textarea>
          </label>
        </div>

        <div class="source-group full-width" data-source-section="structured" hidden>
          <label>
            Structured case JSON
            <textarea name="case_payload" rows="6" placeholder='{"case_id": "LIVE_CASE_001", "title": "Case title", ...}'></textarea>
          </label>
          <p class="hint">Ensure the payload matches the <code>CaseRecord</code> schema exported by the data pipeline.</p>
        </div>

        <div class="source-group full-width" data-source-section="live" hidden>
          <label>
            Seed case ID (optional)
            <input type="text" name="seed_case_id" placeholder="LIVE-20251004-01">
          </label>
          <label>
            Case title
            <input type="text" name="seed_title" placeholder="Emergency case">
          </label>
          <label>
            Summary
            <textarea name="seed_summary" rows="3" placeholder="First report, victim, location, and any initial facts."></textarea>
          </label>
          <label>
            Potential charges (one per line)
            <textarea name="seed_charges" rows="3" placeholder="Intentional injury\nUnlawful detention"></textarea>
          </label>
          <label>
            Key people (one per line)
            <textarea name="seed_people" rows="3" placeholder="Investigator Chen\nWitness Li"></textarea>
          </label>
          <label>
            Location or jurisdiction
            <input type="text" name="seed_location" placeholder="Shanghai Pudong Police Bureau">
          </label>
          <label>
            Additional notes
            <textarea name="seed_notes" rows="3" placeholder="e.g. Awaiting on-site confirmation, no formal paperwork yet."></textarea>
          </label>
          <p class="hint">The system will bootstrap a blank <code>CaseRecord</code> that can be enriched inside the interactive workspace.</p>
        </div>

        <label>
          Session output directory
          <input type="text" name="output_dir" value="outputs/sessions" required>
        </label>
        <label>
          Override case ID (optional)
          <input type="text" name="case_id" placeholder="CASE001">
        </label>
        <label>
          Success probability threshold
          <input type="number" step="0.05" min="0.3" max="0.99" name="success_threshold" value="0.80" required>
        </label>
        <label>
          Maximum iterations
          <input type="number" min="1" max="20" name="max_iterations" value="6">
        </label>
        <label class="checkbox">
          <input type="checkbox" name="persist_snapshots" checked>
          Persist blackboard snapshots
        </label>

        <button type="submit" class="btn">Launch agents</button>
      </form>
      <p id="case-session-message" class="message" role="status" aria-live="polite"></p>
    </section>

    <section class="section-card container" id="case-sessions" data-initial-case-sessions='{{ case_sessions | tojson | safe }}'>
      <header class="section-heading">
        <div>
          <h2>Interactive control rooms</h2>
          <p class="section-subtitle">Monitor live progress, thresholds, and handoffs across every active session.</p>
        </div>
        <div class="section-actions">
          <span class="pill pill--muted" id="session-last-refresh">Just now</span>
          <button type="button" class="btn-tertiary" id="refresh-case-sessions">Refresh</button>
        </div>
      </header>
      <div id="case-session-list" class="cards-grid"></div>
    </section>

    {% if sessions %}
      <section class="section-card container">
        <header class="section-heading">
          <div>
            <h2>Archived sessions</h2>
            <p class="section-subtitle">Snapshots discovered under <code>outputs/sessions</code>. Each card links to the full iteration history.</p>
          </div>
        </header>
        <div class="cards-grid">
          {% for session in sessions %}
            <article class="card">
              <header class="card-header">
                <h3>{{ session.case_id }}</h3>
                <span class="badge">{{ session.iteration_count }} iterations</span>
              </header>
              <p class="card-note">Last updated {{ session.updated_at }}</p>
              <a class="btn btn-small" href="{{ url_for('session_view', case_id=session.case_id) }}">Review session</a>
            </article>
          {% endfor %}
        </div>
      </section>
    {% else %}
      <section class="section-card container empty-state">
        <p>No archived sessions yet. Run <code>python -m src.runtime.session ...</code> to generate data.</p>
      </section>
    {% endif %}
  </main>

  <footer class="site-footer container">
    <p>CaseSentinel keeps every reasoning trace auditable. Extend workflows via <code>src/visualization/dashboard.py</code>.</p>
  </footer>

  <script>
    (function() {
      const form = document.getElementById('case-session-form');
      if (!form) {
        return;
      }
      const message = document.getElementById('case-session-message');
      const caseSessionsSection = document.getElementById('case-sessions');
      const refreshButton = document.getElementById('refresh-case-sessions');
      const sessionList = document.getElementById('case-session-list');
      const sourceRadios = form.querySelectorAll('input[name="case_source"]');
      const sourceGroups = form.querySelectorAll('[data-source-section]');
      const quickButtons = document.querySelectorAll('[data-quickstart]');
      const autoOpenToggle = document.getElementById('auto-open-workspace');
      const lastRefresh = document.getElementById('session-last-refresh');
      const statusCopy = {
        running: 'Running',
        awaiting_decision: 'Awaiting decision',
        completed: 'Completed',
      };

      let sessions = [];
      if (caseSessionsSection) {
        try {
          sessions = JSON.parse(caseSessionsSection.dataset.initialCaseSessions || '[]');
        } catch (error) {
          sessions = [];
        }
      }

      const presets = {
        dataset: () => {
          form.elements['case_source'].value = 'dataset';
          form.elements['cleaned_cases_path'].value = 'outputs/cleaned_cases.jsonl';
          form.elements['case_index'].value = '0';
          form.elements['success_threshold'].value = '0.80';
          form.elements['max_iterations'].value = '6';
          form.elements['persist_snapshots'].checked = true;
        },
        raw: () => {
          form.elements['case_source'].value = 'raw';
          const rawField = form.elements['raw_case_text'];
          if (rawField) {
            rawField.value = 'ÔºàÁ§∫‰æãÔºâÂéüÂßãÊ°à‰ª∂Êñá‰π¶/Âà§ÂÜ≥‰π¶ÊñáÊú¨ÔºåËá™Âä®ÊèêÂèñ CaseRecord„ÄÇ';
          }
          form.elements['success_threshold'].value = '0.80';
          form.elements['max_iterations'].value = '4';
          form.elements['persist_snapshots'].checked = true;
        },
        live: () => {
          form.elements['case_source'].value = 'live';
          form.elements['seed_title'].value = 'Áé∞Âú∫Âø´Êä•ÊºîÁ§∫';
          form.elements['seed_summary'].value = 'Â∑°ÈÄªÊ∞ëË≠¶Êä•Âëä‰∏ÄËµ∑ËΩª‰º§Ê°à‰ª∂ÔºåÁ≠âÂæÖÂèñËØÅ‰∏éÂàùÊ≠•Á¨îÂΩï„ÄÇ';
          form.elements['seed_charges'].value = 'ÊïÖÊÑè‰º§ÂÆ≥\nÈùûÊ≥ïÊãòÁ¶Å';
          form.elements['seed_people'].value = 'Ë≠¶Âëò Zhang\nÁõÆÂáªËÄÖ Li';
          form.elements['seed_location'].value = 'Pudong';
          form.elements['success_threshold'].value = '0.75';
          form.elements['max_iterations'].value = '5';
        },
      };

      function setMessage(text, tone = 'info') {
        if (!message) {
          return;
        }
        message.textContent = text || '';
        message.dataset.tone = tone;
      }

      function touchLastRefresh(label = 'Just now') {
        if (lastRefresh) {
          lastRefresh.textContent = label;
        }
      }

      function updateSourceVisibility() {
        const selected = form.elements['case_source'].value;
        sourceGroups.forEach((group) => {
          const active = group.dataset.sourceSection === selected;
          group.toggleAttribute('hidden', !active);
          group.querySelectorAll('input, textarea').forEach((field) => {
            if (field.name === 'cleaned_cases_path') {
              field.required = selected === 'dataset';
            } else if (field.name === 'raw_case_text') {
              field.required = selected === 'raw';
            } else if (field.name === 'case_payload') {
              field.required = selected === 'structured';
            }
          });
        });
        const caseIndex = form.querySelector('input[name="case_index"]');
        if (caseIndex) {
          const enableIndex = selected === 'dataset';
          caseIndex.disabled = !enableIndex;
          if (!enableIndex) {
            caseIndex.value = '0';
          }
        }
      }

      function toNumber(value, fallback = 0) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : fallback;
      }

      function buildPayload() {
        const data = new FormData(form);
        const selected = data.get('case_source');
        const payload = {
          case_index: toNumber(data.get('case_index'), 0),
          success_threshold: toNumber(data.get('success_threshold'), 0.8),
          max_iterations: toNumber(data.get('max_iterations'), 6),
          persist_snapshots: form.querySelector('input[name="persist_snapshots"]').checked,
          output_dir: (data.get('output_dir') || '').trim() || 'outputs/sessions',
        };

        const caseId = (data.get('case_id') || '').trim();
        if (caseId) {
          payload.case_id = caseId;
        }

        if (selected === 'dataset') {
          const cleanedPath = (data.get('cleaned_cases_path') || '').trim();
          if (cleanedPath) {
            payload.cleaned_cases_path = cleanedPath;
          }
        } else if (selected === 'raw') {
          const rawText = (data.get('raw_case_text') || '').trim();
          if (rawText) {
            payload.raw_case_text = rawText;
          }
        } else if (selected === 'structured') {
          const jsonText = (data.get('case_payload') || '').trim();
          if (jsonText) {
            payload.case_payload = jsonText;
          }
        } else if (selected === 'live') {
          const seed = {
            case_id: (data.get('seed_case_id') || '').trim() || null,
            title: (data.get('seed_title') || '').trim() || null,
            summary: (data.get('seed_summary') || '').trim() || null,
            suspected_charges: (data.get('seed_charges') || '').trim() || null,
            key_people: (data.get('seed_people') || '').trim() || null,
            location: (data.get('seed_location') || '').trim() || null,
            notes: (data.get('seed_notes') || '').trim() || null,
          };
          payload.case_seed = seed;
        }

        return payload;
      }

      function formatProbability(value) {
        if (value === null || value === undefined || value === '') {
          return '‚Äî';
        }
        const formatter = new Intl.NumberFormat('en-US', {
          style: 'percent',
          minimumFractionDigits: 1,
          maximumFractionDigits: 1,
        });
        return formatter.format(Number(value));
      }

      function renderSessions() {
        if (!sessionList) {
          return;
        }
        sessionList.innerHTML = '';
        if (!sessions.length) {
          const empty = document.createElement('p');
          empty.className = 'empty-message';
          empty.textContent = 'No interactive sessions yet. Launch a case to begin.';
          sessionList.appendChild(empty);
          return;
        }

        sessions
          .slice()
          .sort((a, b) => (b.updated_at || '').localeCompare(a.updated_at || ''))
          .forEach((session) => {
            const card = document.createElement('article');
            card.className = 'card session-card';

            const header = document.createElement('header');
            header.className = 'card-header';
            const titleBlock = document.createElement('div');
            const heading = document.createElement('h3');
            heading.textContent = session.case_id;
            const subtitle = document.createElement('p');
            subtitle.className = 'card-subtitle';
            subtitle.textContent = `${statusCopy[session.status] || session.status}`;
            titleBlock.appendChild(heading);
            titleBlock.appendChild(subtitle);

            const badge = document.createElement('span');
            badge.className = `badge badge--${session.status}`;
            badge.textContent = statusCopy[session.status] || session.status;

            header.appendChild(titleBlock);
            header.appendChild(badge);
            card.appendChild(header);

            const metrics = document.createElement('dl');
            metrics.className = 'card-metrics';
            metrics.innerHTML = `
              <div><dt>Progress</dt><dd>${session.current_iteration} / ${session.iteration_limit}</dd></div>
              <div><dt>Latest probability</dt><dd>${formatProbability(session.last_success_probability)}</dd></div>
              <div><dt>Threshold</dt><dd>${formatProbability(session.success_threshold)}</dd></div>
            `;
            card.appendChild(metrics);

            const meta = document.createElement('p');
            meta.className = 'card-note';
            meta.innerHTML = `Next agent: <strong>${session.next_agent || '‚Äî'}</strong>`;
            card.appendChild(meta);

            const actions = document.createElement('div');
            actions.className = 'card-actions';
            const openLink = document.createElement('a');
            openLink.className = 'btn btn-small';
            openLink.href = `/interactive/${session.session_id}`;
            openLink.textContent = 'Open workspace';
            actions.appendChild(openLink);
            card.appendChild(actions);

            sessionList.appendChild(card);
          });
      }

      function maybeOpenWorkspace(sessionId) {
        if (!sessionId) {
          return;
        }
        if (autoOpenToggle && autoOpenToggle.checked) {
          const url = `/interactive/${sessionId}`;
          window.open(url, '_blank', 'noopener');
        }
      }

      async function refreshSessions(showMessage = true) {
        if (!caseSessionsSection) {
          return;
        }
        try {
          if (showMessage) {
            setMessage('Refreshing interactive sessions‚Ä¶');
          }
          const response = await fetch('/api/interactive-sessions');
          if (!response.ok) {
            throw new Error('Failed to refresh sessions');
          }
          sessions = await response.json();
          renderSessions();
          const stamp = new Date();
          touchLastRefresh(`Updated ${stamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`);
          if (showMessage) {
            setMessage('Interactive sessions are up to date.', 'success');
          }
        } catch (error) {
          setMessage('Unable to refresh interactive sessions.', 'error');
        }
      }

      function attachEvents() {
        sourceRadios.forEach((radio) => {
          radio.addEventListener('change', updateSourceVisibility);
        });

        quickButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const preset = button.dataset.quickstart;
            if (presets[preset]) {
              presets[preset]();
              updateSourceVisibility();
              setMessage(`Preset ‚Äú${preset}‚Äù applied. Adjust fields if needed, then launch.`, 'info');
            }
          });
        });

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          setMessage('Launching session‚Ä¶');
          const payload = buildPayload();
          try {
            const response = await fetch('/api/case-sessions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.detail || 'Unable to launch session');
            }
            setMessage(`Interactive session ${data.session_id} is live.`, 'success');
            form.reset();
            form.elements['case_source'].value = payload.case_seed ? 'live' : 'dataset';
            updateSourceVisibility();
            if (data.state) {
              sessions = [data.state].concat(sessions.filter((item) => item.session_id !== data.session_id));
              renderSessions();
            } else {
              refreshSessions(false);
            }
            maybeOpenWorkspace(data.session_id);
          } catch (error) {
            setMessage(error.message, 'error');
          }
        });

        if (refreshButton) {
          refreshButton.addEventListener('click', () => refreshSessions(true));
        }
      }

      updateSourceVisibility();
      renderSessions();
      attachEvents();
    })();
  </script>
</body>
</html>
